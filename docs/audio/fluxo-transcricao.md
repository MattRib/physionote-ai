# Fluxo de Transcri√ß√£o - PhysioNote.AI

## ‚úÖ Status da Implementa√ß√£o: CONCLU√çDO

O sistema est√° **totalmente funcional**. Ap√≥s a grava√ß√£o, a transcri√ß√£o do Whisper gera automaticamente a nota estruturada com GPT-4 e redireciona para a p√°gina `SessionSummary` onde o usu√°rio pode revisar e editar todos os campos.

## üìã Vis√£o Geral

O sistema de transcri√ß√£o foi projetado para minimizar distra√ß√µes durante o atendimento, permitindo que o fisioterapeuta foque totalmente no paciente. A transcri√ß√£o acontece silenciosamente em segundo plano e s√≥ √© apresentada ap√≥s a finaliza√ß√£o da consulta.

---

## üîÑ Fluxo Completo

### 1Ô∏è‚É£ **Antes da Grava√ß√£o** (`sessionStarted = false`)

**Tela Exibida:** Sele√ß√£o de Paciente

**Interface:**
- Card centralizado com logo PhysioNote.AI
- Dropdown de busca de pacientes
- Bot√µes: "Cancelar" e "Iniciar Sess√£o"

**Comportamento:**
- Usu√°rio deve selecionar um paciente antes de prosseguir
- Bot√£o "Iniciar Sess√£o" desabilitado at√© sele√ß√£o de paciente
- Ao clicar em "Iniciar Sess√£o": inicia grava√ß√£o e muda para tela focada

---

### 2Ô∏è‚É£ **Durante a Grava√ß√£o** (`isRecording = true`)

**Tela Exibida:** Interface Focada com Liquid Glass

**Interface Vis√≠vel:**
- ‚úÖ Fundo com efeito liquid glass (blobs animados)
- ‚úÖ Mensagem: "A consulta est√° sendo gravada" (com ponto vermelho pulsante)
- ‚úÖ √çcone de microfone grande e pulsante no centro
- ‚úÖ Ondas sonoras animadas ao redor do microfone
- ‚úÖ Timer (HH:MM:SS) mostrando dura√ß√£o da grava√ß√£o
- ‚úÖ Nome do paciente discreto
- ‚úÖ Bot√£o vermelho: "Finalizar Consulta e Gerar Transcri√ß√£o"
- ‚úÖ Alerta informativo: "Continue com o atendimento normalmente..."

**Interface Oculta:**
- ‚ùå Painel de transcri√ß√£o em tempo real
- ‚ùå Texto da transcri√ß√£o
- ‚ùå Controles de pausa/retomar
- ‚ùå Barras laterais ou menus

**Processo em Background:**
1. **Captura de √Åudio:**
   - MediaRecorder captura √°udio do microfone
   - Dados coletados a cada 1 segundo
   - Stream armazenado como Blob

2. **Simula√ß√£o de Transcri√ß√£o:**
   - Fun√ß√£o `simulateTranscription()` adiciona frases a cada 5 segundos
   - Array `transcription` armazena segmentos
   - **Importante:** Transcri√ß√£o N√ÉO √© exibida ao usu√°rio durante grava√ß√£o

3. **Timer:**
   - Contador incrementa a cada 1 segundo
   - Exibido em formato HH:MM:SS

---

### 3Ô∏è‚É£ **Finalizando a Grava√ß√£o** (`isFinishing = true`)

**Tela Exibida:** Anima√ß√£o de Transi√ß√£o

**Interface:**
- Tela mant√©m efeito liquid glass
- Spinner animado (Loader2)
- Mensagem: "Finalizando consulta..."
- Submensagem: "Processando grava√ß√£o e gerando transcri√ß√£o"

**Processo:**
1. Bot√£o "Finalizar" clicado
2. Estado `isFinishing = true`
3. MediaRecorder para grava√ß√£o
4. Stream de √°udio encerrado
5. Aguarda 2 segundos (anima√ß√£o de transi√ß√£o)
6. Muda para tela de resumo (`showSummary = true`)

**Dura√ß√£o:** 2 segundos

---

### 4Ô∏è‚É£ **Ap√≥s Finaliza√ß√£o** (`showSummary = true`)

**Tela Exibida:** Resumo da Sess√£o (SessionSummary)

**Se√ß√£o 1: Header**
- ‚úÖ √çcone de check verde: "Sess√£o Finalizada"
- ‚úÖ Informa√ß√µes da sess√£o:
  - Nome do paciente
  - Dura√ß√£o da consulta (HH:MM:SS)
  - N√∫mero de segmentos transcritos

**Se√ß√£o 2: Transcri√ß√£o Completa** (‚≠ê NOVIDADE)

**Funcionalidades:**

1. **Visualiza√ß√£o por padr√£o (Ocultar/Exibir)**
   - Transcri√ß√£o aparece expandida automaticamente
   - Bot√£o "Ocultar" permite esconder se necess√°rio
   - Bot√£o "Exibir" mostra novamente quando oculta

2. **Modo de Visualiza√ß√£o:**
   - Transcri√ß√£o exibida em cards numerados
   - Cada segmento em uma linha separada
   - Background branco com bordas para melhor legibilidade
   - Scroll vertical para transcri√ß√µes longas (max-height: 500px)
   - **Bot√µes dispon√≠veis:**
     - üìã **Copiar:** Copia toda transcri√ß√£o para √°rea de transfer√™ncia
     - ‚úèÔ∏è **Editar Transcri√ß√£o:** Entra em modo de edi√ß√£o
     - üì• **Exportar PDF:** Gera documento PDF

3. **Modo de Edi√ß√£o:**
   - Textarea grande com toda transcri√ß√£o (20 linhas)
   - Fonte monoespa√ßada para melhor leitura
   - Alerta azul explicando o modo de edi√ß√£o
   - **Bot√µes dispon√≠veis:**
     - ‚ùå **Cancelar:** Descarta altera√ß√µes e volta ao modo visualiza√ß√£o
     - üíæ **Salvar Altera√ß√µes:** Salva edi√ß√µes e volta ao modo visualiza√ß√£o

**Se√ß√£o 3: Informa√ß√µes Adicionais**

Campos de texto para complementar a documenta√ß√£o:
- üîç **Diagn√≥stico / Avalia√ß√£o:** Diagn√≥stico cl√≠nico e avalia√ß√£o inicial
- üíä **Tratamento Realizado:** Procedimentos e t√©cnicas aplicadas
- üìù **Orienta√ß√µes e Pr√≥ximos Passos:** Planejamento de continuidade
- üìå **Observa√ß√µes Gerais:** Notas adicionais relevantes

**Se√ß√£o 4: A√ß√µes Finais**
- ‚ùå **Descartar:** Cancela sess√£o (com confirma√ß√£o)
- üíæ **Salvar Sess√£o:** Salva todos os dados e volta ao dashboard

---

## üéØ Benef√≠cios da Abordagem

### ‚úÖ Durante a Grava√ß√£o:
1. **Zero Distra√ß√µes:** Profissional foca 100% no paciente
2. **Interface Limpa:** Design minimalista e focado
3. **Feedback Visual:** Anima√ß√µes indicam que sistema est√° funcionando
4. **Confian√ßa:** Timer e indicadores mostram que est√° gravando

### ‚úÖ Ap√≥s a Grava√ß√£o:
1. **Revis√£o Completa:** Transcri√ß√£o inteira dispon√≠vel para an√°lise
2. **Edi√ß√£o F√°cil:** Corrigir erros de transcri√ß√£o automaticamente
3. **Flexibilidade:** Ocultar/exibir conforme necessidade
4. **Exporta√ß√£o:** M√∫ltiplas op√ß√µes de sa√≠da (PDF, c√≥pia)
5. **Contextualiza√ß√£o:** Adicionar diagn√≥stico, tratamento e orienta√ß√µes

---

## üîß Componentes T√©cnicos

### `SessionView.tsx`
**Responsabilidades:**
- Gerenciar estados da sess√£o (n√£o iniciada, gravando, finalizando, resumo)
- Capturar √°udio com MediaRecorder API
- Coletar transcri√ß√£o em background (simula√ß√£o)
- Renderizar interface focada durante grava√ß√£o
- **N√ÉO exibe transcri√ß√£o durante grava√ß√£o**

**Estados Principais:**
```typescript
const [sessionStarted, setSessionStarted] = useState(false);
const [isRecording, setIsRecording] = useState(false);
const [isFinishing, setIsFinishing] = useState(false);
const [showSummary, setShowSummary] = useState(false);
const [transcription, setTranscription] = useState<string[]>([]); // Oculta do usu√°rio
```

### `SessionSummary.tsx`
**Responsabilidades:**
- Exibir transcri√ß√£o completa ap√≥s finaliza√ß√£o
- Permitir ocultar/exibir transcri√ß√£o
- Modo de edi√ß√£o de transcri√ß√£o
- Copiar transcri√ß√£o para clipboard
- Campos para informa√ß√µes adicionais
- Salvar ou descartar sess√£o

**Estados Principais:**
```typescript
const [showTranscription, setShowTranscription] = useState(true);
const [isEditingTranscription, setIsEditingTranscription] = useState(false);
const [editedTranscription, setEditedTranscription] = useState(string);
const [copied, setCopied] = useState(false);
```

---

## ü§ñ Processamento com IA (Whisper + GPT-4)

### Etapa 1: Finalizar Grava√ß√£o
**Fun√ß√£o:** `handleStopSession()` em `SessionView.tsx`

```typescript
// 1. Para MediaRecorder
mediaRecorderRef.current.stop();
setIsRecording(false);

// 2. Cria Blob de √°udio
const audioBlob = new Blob(audioChunksRef.current, { type: 'audio/webm' });
```

### Etapa 2: Upload do √Åudio
**Endpoint:** `POST /api/sessions/[id]/audio`

```typescript
// Upload FormData com arquivo de √°udio
const formData = new FormData();
formData.append('audio', audioBlob, 'recording.webm');

await fetch(`/api/sessions/${sessionId}/audio`, {
  method: 'POST',
  body: formData
});

// Valida√ß√µes:
- Tamanho m√°ximo: 25MB
- Formatos: webm, mp3, wav, m4a
- Salva em: uploads/audio/[sessionId].webm
- Atualiza: session.audioUrl no banco
```

### Etapa 3: Processar com IA
**Endpoint:** `POST /api/sessions/[id]/process`

#### 3.1. Transcri√ß√£o com Whisper
```typescript
// Status: "transcribing"
const transcription = await transcribeAudio(audioPath, 'pt');

// Salva no banco
await prisma.session.update({
  data: {
    transcription: transcription.text,
    status: 'generating'
  }
});
```

**API Utilizada:**
- Modelo: `whisper-1` (OpenAI)
- Idioma: Portugu√™s (`pt`)
- Custo: $0.006/minuto
- Tempo m√©dio: 20-30 segundos para 30 min de √°udio

#### 3.2. Gera√ß√£o de Nota com GPT-4
```typescript
// Status: "generating"
const { note, model } = await generateNoteFromTranscription({
  transcription: text,
  patientName: session.patient.name,
  patientAge: calculatedAge,
  patientGender: session.patient.gender,
  sessionDate: session.date
});
```

**API Utilizada:**
- Modelo: `gpt-4o` (OpenAI)
- Prompt: Especializado para fisioterapia
- Formato: JSON estruturado (baseado em SOAP)
- Custo m√©dio: $0.15 por nota
- Tempo m√©dio: 10-20 segundos

**Estrutura da Nota Gerada:**
```json
{
  "resumoExecutivo": {
    "queixaPrincipal": "string",
    "nivelDor": 0-10,
    "evolucao": "string"
  },
  "anamnese": {
    "historicoAtual": "string",
    "antecedentesPessoais": "string",
    "medicamentos": "string",
    "objetivos": "string"
  },
  "diagnosticoFisioterapeutico": {
    "principal": "string",
    "secundario": ["string[]"],
    "cif": "string"
  },
  "intervencoes": {
    "tecnicasManuais": ["string[]"],
    "exerciciosTerapeuticos": ["string[]"],
    "recursosEletrotermofototerapeticos": ["string[]"]
  },
  "respostaTratamento": {
    "imediata": "string",
    "efeitos": "string",
    "feedback": "string"
  },
  "orientacoes": {
    "domiciliares": ["string[]"],
    "ergonomicas": ["string[]"],
    "precaucoes": ["string[]"]
  },
  "planoTratamento": {
    "frequencia": "string",
    "duracaoPrevista": "string",
    "objetivosCurtoPrazo": ["string[]"],
    "objetivosLongoPrazo": ["string[]"],
    "criteriosAlta": ["string[]"]
  },
  "observacoesAdicionais": "string",
  "proximaSessao": {
    "data": "string",
    "foco": "string"
  }
}
```

#### 3.3. Salvamento da Nota
```typescript
// Cria ou atualiza nota no banco
await prisma.note.upsert({
  where: { sessionId },
  create: {
    contentJson: JSON.stringify(note),
    aiGenerated: true,
    aiModel: 'gpt-4o',
    aiPromptUsed: prompt
  }
});

// Marca sess√£o como completa
await prisma.session.update({
  data: { status: 'completed' }
});
```

### Etapa 4: Redirecionamento para SessionSummary
**Volta para:** `SessionView.tsx`

```typescript
// Ap√≥s sucesso do processamento
const result = await processResponse.json();

// Atualiza transcri√ß√£o (dividida em frases)
if (result.session?.transcription) {
  const sentences = result.session.transcription
    .split(/[.!?]+/)
    .map(s => s.trim())
    .filter(s => s.length > 0);
  setTranscription(sentences);
}

// üéØ REDIRECIONA PARA SESSIONSUMMARY
setShowSummary(true);
```

### Etapa 5: Renderiza√ß√£o do SessionSummary
**Componente:** `SessionSummary_fullscreen.tsx`

```typescript
// SessionView renderiza SessionSummary quando showSummary=true
if (showSummary) {
  return (
    <SessionSummary
      patient={selectedPatient!}
      duration={duration}
      transcription={transcription}  // ‚Üê Texto do Whisper
      onSave={handleSaveSession}
      onCancel={handleCancelSession}
      showAIDisclaimer={true}
    />
  );
}
```

**O SessionSummary exibe:**
- ‚úÖ Informa√ß√µes da sess√£o (paciente, data, dura√ß√£o)
- ‚úÖ Nota estruturada em se√ß√µes colaps√°veis (dados do GPT-4)
- ‚úÖ Transcri√ß√£o original (texto do Whisper)
- ‚úÖ Todos os campos s√£o **edit√°veis**
- ‚úÖ Bot√µes: Copiar, Exportar PDF, Salvar, Descartar

---

## üìä Estados da Sess√£o

```
recording      ‚Üí Gravando √°udio
  ‚Üì
uploaded       ‚Üí √Åudio enviado
  ‚Üì
transcribing   ‚Üí Whisper processando (~20-30s)
  ‚Üì
generating     ‚Üí GPT-4 gerando nota (~10-20s)
  ‚Üì
completed      ‚Üí ‚úÖ Nota gerada e salva
  ‚Üì
(showSummary=true) ‚Üí SessionSummary renderizado
```

**Feedback Visual Durante Processamento:**
```
"Finalizando grava√ß√£o..."
"Preparando √°udio..."
"Enviando √°udio..."
"Transcrevendo com IA..."  ‚Üê Whisper
"Conclu√≠do!"               ‚Üê Pronto!
```

---

## üí∞ Custos por Sess√£o (30 minutos)

| Servi√ßo | Modelo | Custo |
|---------|--------|-------|
| Whisper | whisper-1 | $0.18 |
| GPT-4 | gpt-4o | $0.15 |
| **Total** | - | **$0.33** |

---

## üöÄ Pr√≥ximas Melhorias

### Transcri√ß√£o Real
- [ ] Integrar API de Speech-to-Text (Google Cloud, Azure, AWS)
- [ ] Implementar streaming de transcri√ß√£o em tempo real (backend)
- [ ] Adicionar suporte para m√∫ltiplos idiomas
- [ ] Detectar termos m√©dicos e fisioterap√™uticos

### Edi√ß√£o Avan√ßada
- [ ] Timestamps para cada segmento
- [ ] Marca√ß√£o de t√≥picos/se√ß√µes
- [ ] Busca dentro da transcri√ß√£o
- [ ] Destaque de termos-chave

### Exporta√ß√£o
- [ ] Gera√ß√£o real de PDF com formata√ß√£o profissional
- [ ] Exportar para Word (.docx)
- [ ] Envio por email direto ao paciente
- [ ] Integra√ß√£o com prontu√°rio eletr√¥nico

### IA Generativa
- [ ] Sugest√µes autom√°ticas de diagn√≥stico baseadas na transcri√ß√£o
- [ ] Auto-preenchimento de tratamentos comuns
- [ ] Resumo autom√°tico da consulta
- [ ] Gera√ß√£o de relat√≥rio t√©cnico

---

## üìä Fluxograma Visual

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Sele√ß√£o Paciente   ‚îÇ
‚îÇ  (sessionStarted=F) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Clicar "Iniciar Sess√£o"
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Gravando Consulta  ‚îÇ‚óÑ‚îÄ‚îÄ‚îê
‚îÇ  (isRecording=T)    ‚îÇ   ‚îÇ Transcri√ß√£o em
‚îÇ  üéôÔ∏è Interface Focada‚îÇ   ‚îÇ background (oculta)
‚îÇ  ‚ùå SEM Transcri√ß√£o ‚îÇ   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
           ‚îÇ Clicar "Finalizar"
           ‚ñº               ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  Finalizando...     ‚îÇ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ  (isFinishing=T)    ‚îÇ Processa dados
‚îÇ  ‚è≥ 2 segundos      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Resumo da Sess√£o   ‚îÇ
‚îÇ  (showSummary=T)    ‚îÇ
‚îÇ  ‚úÖ Transcri√ß√£o     ‚îÇ‚îÄ‚îÄ‚ñ∫ Exibir/Ocultar
‚îÇ  ‚úèÔ∏è  Editar         ‚îÇ‚îÄ‚îÄ‚ñ∫ Modo Edi√ß√£o
‚îÇ  üìã Copiar          ‚îÇ‚îÄ‚îÄ‚ñ∫ Clipboard
‚îÇ  üì• Exportar        ‚îÇ‚îÄ‚îÄ‚ñ∫ PDF
‚îÇ  üíæ Salvar          ‚îÇ‚îÄ‚îÄ‚ñ∫ Dashboard
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üí° Observa√ß√µes Importantes

1. **Privacidade:** Transcri√ß√£o oculta durante grava√ß√£o protege privacidade do paciente
2. **Experi√™ncia:** Interface limpa melhora experi√™ncia do profissional
3. **Flexibilidade:** Edi√ß√£o posterior permite corre√ß√£o de erros de IA
4. **Compliance:** Documenta√ß√£o completa facilita auditoria e regulamenta√ß√µes
5. **Efici√™ncia:** Menos cliques e distra√ß√µes = mais foco no atendimento

---

**√öltima Atualiza√ß√£o:** Outubro 2025  
**Vers√£o:** 2.0 - Transcri√ß√£o Focada e Edit√°vel
